<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bifrost Card Effects Lab</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a12;color:#eee;font-family:'Space Grotesk',sans-serif;min-height:100vh;display:flex;flex-direction:column;align-items:center}
.lab-header{text-align:center;padding:2rem 2rem 1.2rem;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);border-bottom:1px solid #333;margin-bottom:2rem;width:100%}
.lab-header h1{font-family:'Cinzel Decorative',serif;font-size:2rem;margin-bottom:0.25rem}
.lab-header h1 .emoji{-webkit-text-fill-color:initial}
.lab-header h1 .brand{background:linear-gradient(90deg,#ff6b6b,#feca57,#48dbfb,#ff9ff3,#54a0ff,#5f27cd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.lab-header .tagline{color:#666;font-size:0.72rem;margin-bottom:0.5rem;line-height:1.4}
.lab-header .subtitle{color:#888;font-size:0.85rem}
.lab-header .alias{color:#54a0ff;font-family:'JetBrains Mono',monospace}
.lab-header .pack-status{color:#555;font-size:0.75rem;font-family:'JetBrains Mono',monospace;margin-top:0.5rem}
.lab-content{display:flex;gap:2rem;max-width:1100px;width:100%}
.preview-panel{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:1rem;position:sticky;top:2rem;align-self:flex-start}
.controls-panel{flex:1;min-width:0}
.section{background:#16213e;border:1px solid #0f3460;border-radius:10px;padding:1.25rem;margin-bottom:1rem}
.section h3{font-size:0.9rem;color:#54a0ff;margin-bottom:0.75rem}

/* Preview card */
.preview-boundary{padding:15px;margin:-15px;position:relative}
.bf-badge{
  --rotateX:0deg;--rotateY:0deg;--glossX:50%;--glossY:50%;
  --parallax-x:0px;--parallax-y:0px;
  --frame-color:#16213e;--frame-accent:#0f3460;--border-color:#0f3460;--border-width:2px;
  --frame-padding:10px;--card-radius:12px;--art-margin:11px;--window-h:0px;--text-zone-h:52px;
  width:180px;position:relative;overflow:hidden;cursor:pointer;
  border-radius:var(--card-radius);border:var(--border-width) solid var(--border-color);
  background:var(--frame-color);
  transform:perspective(1000px) rotateX(var(--rotateX)) rotateY(var(--rotateY));
  transition:border-color 0.2s ease,box-shadow 0.2s ease;
}
.bf-badge:hover{border-color:#54a0ff;box-shadow:0 8px 25px rgba(84,160,255,0.2),0 0 20px rgba(84,160,255,0.1)}
.bf-badge-sizer{width:calc(100% - var(--frame-padding)*2);aspect-ratio:3/4;margin:var(--frame-padding) auto 0;padding-bottom:var(--text-zone-h);visibility:hidden;pointer-events:none}
.bf-layer-bottom{position:absolute;inset:0;z-index:1;transform:translateX(calc(var(--parallax-x)*-1)) translateY(calc(var(--parallax-y)*-1))}
.bf-art-image{display:block;position:absolute;top:calc(var(--frame-padding) - var(--art-margin));left:calc(var(--frame-padding) - var(--art-margin));width:calc(100% - var(--frame-padding)*2 + var(--art-margin)*2);height:calc(var(--window-h) + var(--art-margin)*2);object-fit:cover;object-position:center top}
.bf-art-placeholder{position:absolute;top:var(--frame-padding);left:var(--frame-padding);right:var(--frame-padding);height:var(--window-h);background:#0a0a1a;display:flex;align-items:center;justify-content:center;font-size:3rem;opacity:0.4}
.bf-layer-mid{position:absolute;inset:0;overflow:hidden;z-index:2;pointer-events:none;transform:translateX(calc(var(--parallax-x)*-0.5)) translateY(calc(var(--parallax-y)*-0.5))}
.bf-layer-top{position:absolute;top:-2px;left:-2px;right:-2px;bottom:-2px;z-index:3;pointer-events:none}
.bf-frame-surface{position:absolute;inset:0;border-radius:var(--card-radius);overflow:hidden;background:var(--frame-color);
  clip-path:polygon(0% 0%,100% 0%,100% 100%,0% 100%,0% 0%,var(--frame-padding) var(--frame-padding),var(--frame-padding) calc(var(--frame-padding) + var(--window-h)),calc(100% - var(--frame-padding)) calc(var(--frame-padding) + var(--window-h)),calc(100% - var(--frame-padding)) var(--frame-padding),var(--frame-padding) var(--frame-padding))}
.bf-art-window-border{position:absolute;top:var(--frame-padding);left:var(--frame-padding);right:var(--frame-padding);height:var(--window-h);border:1px solid var(--frame-accent);pointer-events:none;z-index:4}
.bf-gloss-overlay{position:absolute;inset:0;border-radius:var(--card-radius);pointer-events:none;z-index:5;opacity:0;transition:opacity 0.3s ease;background:radial-gradient(circle at var(--glossX) var(--glossY),rgba(255,255,255,0.2) 0%,rgba(255,255,255,0.08) 25%,transparent 50%)}
.bf-badge.has-gloss:hover .bf-gloss-overlay{opacity:1}
.bf-text-zone{position:absolute;bottom:0;left:0;right:0;padding:8px var(--frame-padding) var(--frame-padding);text-align:center;z-index:6}
.bf-badge-name{font-size:0.95rem;font-weight:600;color:#eee;line-height:1.2}
.bf-badge-alias{font-size:0.75rem;color:#888;margin-top:2px;font-family:monospace}

/* Controls */
.pack-toggle{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0.75rem;background:#0d0d1a;border:1px solid #333;border-radius:6px;margin-bottom:0.5rem;cursor:pointer;transition:border-color 0.2s}
.pack-toggle:hover{border-color:#54a0ff}
.pack-toggle.enabled{border-color:#00ff88;background:rgba(0,255,136,0.05)}
.pack-info{display:flex;flex-direction:column;gap:0.1rem}
.pack-name{color:#ccc;font-size:0.85rem}
.pack-count{color:#666;font-size:0.7rem}
.pack-switch{width:40px;height:20px;background:#333;border-radius:10px;position:relative;transition:background 0.2s;flex-shrink:0}
.pack-switch.on{background:#00ff88}
.pack-switch::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:transform 0.2s}
.pack-switch.on::after{transform:translateX(20px)}
.pack-effects{margin-top:0.5rem;display:none}
.pack-effects.visible{display:block}
.effects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:0.4rem}
.effect-btn{padding:0.4rem 0.5rem;background:#0d0d1a;border:1px solid #333;border-radius:6px;color:#ccc;font-size:0.75rem;cursor:pointer;transition:all 0.2s;text-align:center;user-select:none}
.effect-btn:hover{border-color:#54a0ff;color:#fff}
.effect-btn.active{border-color:#e94560;background:rgba(233,69,96,0.1);color:#e94560}
.shorthand-display{background:#0d0d1a;border:1px solid #333;border-radius:6px;padding:0.75rem;font-family:'JetBrains Mono',monospace;font-size:0.8rem;color:#00ff88;word-break:break-all;min-height:2.5rem;width:100%;resize:vertical;cursor:text;outline:none}
.shorthand-display:focus{border-color:#00ff88}
.preset-btn{border-color:#f59e0b !important;color:#f59e0b !important;background:rgba(245,158,11,0.05) !important}
.preset-btn:hover{background:rgba(245,158,11,0.15) !important}
.preset-btn.active{background:rgba(245,158,11,0.2) !important}
.action-buttons{display:flex;gap:0.75rem;margin-top:1rem}
.action-btn{flex:1;padding:0.75rem 1rem;border:1px solid;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-align:center;user-select:none}
.action-btn.save{background:rgba(0,255,136,0.1);border-color:#00ff88;color:#00ff88}
.action-btn.save:hover{background:rgba(0,255,136,0.2);box-shadow:0 0 12px rgba(0,255,136,0.3)}
.action-btn.apply{background:rgba(245,158,11,0.1);border-color:#f59e0b;color:#f59e0b}
.action-btn.apply:hover{background:rgba(245,158,11,0.2);box-shadow:0 0 12px rgba(245,158,11,0.3)}
.action-btn.copy{background:rgba(84,160,255,0.1);border-color:#54a0ff;color:#54a0ff}
.action-btn.copy:hover{background:rgba(84,160,255,0.2);box-shadow:0 0 12px rgba(84,160,255,0.3)}
.action-btn.clear{background:rgba(233,69,96,0.1);border-color:#e94560;color:#e94560;flex:0.3}
.action-btn.clear:hover{background:rgba(233,69,96,0.2)}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:#16213e;border:1px solid #00ff88;color:#00ff88;padding:0.75rem 1.5rem;border-radius:8px;font-size:0.85rem;transition:transform 0.3s ease;z-index:999}
.toast.show{transform:translateX(-50%) translateY(0)}
.loading-msg{color:#666;font-size:0.85rem;text-align:center;padding:1rem}
.cat-label{color:#666;font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;margin:0.75rem 0 0.3rem;padding-bottom:0.2rem;border-bottom:1px solid #1a1a2e}
.ascii-section{background:#111;border:1px solid #333;border-radius:10px;padding:1rem;margin-top:1rem}
.ascii-controls{background:#0d0d1a;border:1px solid #333;border-radius:8px;padding:0.75rem;margin-top:0.4rem}
.ascii-select{width:100%;background:#16213e;color:#00ff88;border:1px solid #333;border-radius:6px;padding:0.4rem;font-family:monospace;font-size:0.8rem;margin-bottom:0.5rem}
.ascii-options{display:flex;gap:1rem;margin-bottom:0.5rem;flex-wrap:wrap}
.ascii-options label{color:#888;font-size:0.75rem;display:flex;align-items:center;gap:0.3rem}
.ascii-options select{background:#16213e;color:#aaa;border:1px solid #333;border-radius:4px;padding:0.25rem;font-size:0.7rem}
.ascii-play-btn{display:inline-block;margin-top:0.25rem}
</style>
</head>
<body>

<div class="lab-header">
  <h1><span class="emoji">üåå</span> <span class="brand">BIFROST</span></h1>
  <div class="tagline">Phonetool port of the standalone Card Architecture Blueprint ‚Äî Modular Effects Lab<br>from <span class="alias">@xburton</span>'s open source arcade software</div>
  <div class="subtitle" id="subtitle">Loading...</div>
  <div class="pack-status" id="packStatus"></div>
</div>

<div class="lab-content" style="padding:0 2rem">
  <div class="preview-panel">
    <div class="preview-boundary" id="previewBoundary">
      <div class="bf-badge has-gloss" id="previewCard">
        <div class="bf-badge-sizer"></div>
        <div class="bf-layer-bottom" id="layerBottom">
          <div class="bf-art-placeholder" id="artPlaceholder">üßë</div>
          <img class="bf-art-image" id="artImage" src="" alt="" onerror="this.style.display='none'"/>
        </div>
        <div class="bf-layer-mid" id="layerMid"></div>
        <div class="bf-layer-top" id="layerTop">
          <div class="bf-frame-surface"></div>
          <div class="bf-art-window-border"></div>
        </div>
        <div class="bf-gloss-overlay"></div>
        <div class="bf-text-zone" id="textZone">
          <div class="bf-badge-name" id="badgeName"></div>
          <div class="bf-badge-alias" id="badgeAlias"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls-panel">
    <div class="section">
      <h3>Effect Packs</h3>
      <div id="packList"><div class="loading-msg">Loading packs...</div></div>
    </div>
    <div class="section">
      <h3>Current Shorthand</h3>
      <textarea class="shorthand-display" id="shorthandDisplay" rows="2" spellcheck="false">No effects selected</textarea>
      <div class="action-buttons">
        <div class="action-btn apply" id="btnApply">‚ñ∂ Apply</div>
        <div class="action-btn save" id="btnSave">üíæ Save</div>
        <div class="action-btn copy" id="btnCopy">üìã Copy</div>
        <div class="action-btn clear" id="btnClear">‚úï</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ============================================================ -->
<!-- CONFIGURATION ‚Äî Update this URL to your drive folder          -->
<!-- ============================================================ -->
<script>
const LAB_CONFIG = {
  ROOT: 'REPLACE_WITH_YOUR_DRIVE_URL',
  MANIFEST: 'REPLACE_WITH_YOUR_DRIVE_URL/pack_manifest.json',
  BROADCAST_CHANNEL: 'bifrost-badge-channel' // legacy, now uses postMessage
};
</script>

<!-- ============================================================ -->
<!-- Engine loads first, then packs via manifest, then lab init    -->
<!-- ============================================================ -->
<script>
(function() {
  // ---- Read query params ----
  const params = new URLSearchParams(window.location.search);
  const ALIAS = params.get('alias') || 'unknown';
  const PHOTO = params.get('photo') || '';
  const NAME = params.get('name') || 'Unknown User';
  const FX = params.get('fx') || '';

  // Populate the card
  document.getElementById('subtitle').innerHTML =
    'Customizing badge for <span class="alias">@' + ALIAS + '</span> &mdash; ' + NAME;
  document.getElementById('artImage').alt = NAME;
  
  // Load badge photo ‚Äî prime auth cookies first, then load image
  var artImg = document.getElementById('artImage');
  function loadPhoto() {
    artImg.onload = function() {
      document.getElementById('artPlaceholder').style.display = 'none';
      console.log('[Lab] Photo loaded');
      // Recompute card layout now that image is ready
      computeWindowH();
    };
    artImg.onerror = function() {
      // First attempt may fail but primes auth cookies via redirect
      // Retry once after a short delay
      console.log('[Lab] Photo failed, retrying in 1.5s...');
      artImg.onerror = function() {
        console.log('[Lab] Photo failed on retry');
        artImg.style.display = 'none';
      };
      setTimeout(function() {
        artImg.src = PHOTO;
      }, 1500);
    };
    artImg.src = PHOTO;
  }
  if (PHOTO) loadPhoto();
  document.getElementById('badgeName').textContent = NAME;
  document.getElementById('badgeAlias').textContent = '@' + ALIAS;
  if (FX) document.getElementById('shorthandDisplay').value = FX;

  // ---- Card preview setup ----
  const card = document.getElementById('previewCard');
  const boundary = document.getElementById('previewBoundary');
  const tiltState = { x: 0, y: 0 };

  function computeWindowH() {
    const padding = 10;
    const textZoneH = 52;
    const artMargin = 11;
    const winW = card.offsetWidth - padding * 2;
    if (winW <= 0) {
      console.log('[Lab] computeWindowH: card not laid out yet, width=' + card.offsetWidth);
      return;
    }
    const winH = winW * (4/3);
    card.style.setProperty('--window-h', winH + 'px');
    // Explicitly set card height to ensure text zone has room
    const totalH = padding + winH + textZoneH + padding;
    card.style.height = totalH + 'px';
    // Force art image dimensions explicitly as backup
    var img = document.getElementById('artImage');
    if (img) {
      img.style.top = (padding - artMargin) + 'px';
      img.style.left = (padding - artMargin) + 'px';
      img.style.width = (winW + artMargin * 2) + 'px';
      img.style.height = (winH + artMargin * 2) + 'px';
    }
    // Force placeholder dimensions too
    var ph = document.getElementById('artPlaceholder');
    if (ph) {
      ph.style.top = padding + 'px';
      ph.style.left = padding + 'px';
      ph.style.width = winW + 'px';
      ph.style.height = winH + 'px';
    }
    console.log('[Lab] computeWindowH: winW=' + winW + ', winH=' + winH + ', totalH=' + totalH);
  }
  // Multiple timing strategies to ensure it fires after layout
  computeWindowH();
  requestAnimationFrame(computeWindowH);
  requestAnimationFrame(function() { requestAnimationFrame(computeWindowH); });
  setTimeout(computeWindowH, 50);
  setTimeout(computeWindowH, 200);
  setTimeout(computeWindowH, 500);
  new ResizeObserver(computeWindowH).observe(card);
  window.addEventListener('load', computeWindowH);
  window.addEventListener('DOMContentLoaded', computeWindowH);

  // Tilt
  boundary.addEventListener('mousemove', function(e) {
    const rect = card.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    const cx = rect.width/2, cy = rect.height/2;
    const nx = (x-cx)/cx, ny = (y-cy)/cy;
    tiltState.x = nx; tiltState.y = ny;
    card.style.setProperty('--rotateX', (ny*-12)+'deg');
    card.style.setProperty('--rotateY', (nx*12)+'deg');
    card.style.setProperty('--glossX', (x/rect.width*100)+'%');
    card.style.setProperty('--glossY', (y/rect.height*100)+'%');
    card.style.setProperty('--parallax-x', (nx*8.5)+'px');
    card.style.setProperty('--parallax-y', (ny*8.5)+'px');
  });
  boundary.addEventListener('mouseleave', function() {
    tiltState.x = 0; tiltState.y = 0;
    card.style.setProperty('--rotateX','0deg');
    card.style.setProperty('--rotateY','0deg');
    card.style.setProperty('--glossX','50%');
    card.style.setProperty('--glossY','50%');
    card.style.setProperty('--parallax-x','0px');
    card.style.setProperty('--parallax-y','0px');
  });

  // ---- Load engine, then manifest, then packs ----
  function loadScript(url) {
    return new Promise(function(resolve, reject) {
      var s = document.createElement('script');
      s.src = url;
      s.onload = resolve;
      s.onerror = function() { console.warn('[Lab] Failed to load:', url); resolve(); };
      document.head.appendChild(s);
    });
  }

  // Load engine first
  loadScript(LAB_CONFIG.ROOT + '/bifrost-engine.js').then(function() {
    console.log('[Lab] Engine loaded:', !!window.Bifrost);

    // Fetch manifest
    return fetch(LAB_CONFIG.MANIFEST, { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .catch(function() {
        console.warn('[Lab] Failed to fetch manifest');
        return { packs: [] };
      });
  }).then(function(manifest) {
    // Load all packs
    var packUrls = (manifest.packs || []).map(function(p) { return p.url; }).filter(Boolean);
    console.log('[Lab] Loading', packUrls.length, 'packs');
    return Promise.all(packUrls.map(loadScript));
  }).then(function() {
    // Everything loaded ‚Äî init
    initLab(ALIAS, FX, tiltState);
  });

  // ---- Store on window for initLab ----
  window._labParams = { alias: ALIAS, photo: PHOTO, name: NAME, fx: FX };
})();

// ============================================================
// LAB INIT ‚Äî called after engine + packs are loaded
// ============================================================
function initLab(alias, initialFx, tiltState) {
  const card = document.getElementById('previewCard');
  // Send message to phonetool tab via postMessage (cross-origin safe)
  function sendToPhoneTool(data) {
    if (window.opener && !window.opener.closed) {
      try {
        window.opener.postMessage(data, '*');
        return true;
      } catch(e) {}
    }
    return false;
  }
  const selections = new Map();
  let currentShorthand = initialFx || '';

  // Init Bifrost engine
  if (window.Bifrost) {
    Bifrost.init(card, {
      top: document.getElementById('layerTop'),
      mid: document.getElementById('layerMid'),
      bot: document.getElementById('layerBottom'),
      text: document.getElementById('textZone')
    }, tiltState, null);

    var packCount = Object.keys(Bifrost.packs).length;
    var effectCount = Object.keys(Bifrost.effects).length;
    var asciiCount = Object.keys(Bifrost.getAllAsciiAnims ? Bifrost.getAllAsciiAnims() : {}).length;
    document.getElementById('packStatus').textContent =
      packCount + ' packs ¬∑ ' + effectCount + ' effects ¬∑ ' + asciiCount + ' ASCII animations';
    console.log('[Lab] Bifrost initialized:', packCount, 'packs,', effectCount, 'effects,', asciiCount, 'ASCII');
  } else {
    document.getElementById('packStatus').textContent = 'Engine failed to load';
    console.error('[Lab] Bifrost engine not available');
  }

  // Apply initial shorthand
  if (currentShorthand && window.Bifrost) {
    Bifrost.applyShorthand(currentShorthand);
  }

  // ---- Build pack UI ----
  buildPackUI();

  function buildPackUI() {
    var packList = document.getElementById('packList');
    packList.innerHTML = '';

    if (!window.Bifrost || Object.keys(Bifrost.packs).length === 0) {
      packList.innerHTML = '<div class="loading-msg">No packs loaded</div>';
      return;
    }

    // Category display order
    var catOrder = ['particle', 'flyover', 'overlay', 'distortion', 'light', 'environment', 'border', 'frame', 'text'];
    var catLabels = { particle: 'üåßÔ∏è Particles', flyover: '‚úàÔ∏è Flyovers', overlay: 'üî≤ Overlays', distortion: 'üëæ Distortion', light: 'üí° Light', environment: 'üåç Environment', border: 'üî≤ Borders', frame: 'üñºÔ∏è Frame', text: '‚úèÔ∏è Text', other: '‚ú¶ Other' };

    for (var _i = 0, _entries = Object.entries(Bifrost.packs); _i < _entries.length; _i++) {
      var packId = _entries[_i][0];
      var pack = _entries[_i][1];
      var effectIds = Object.keys(pack.effects || {});
      var asciiIds = Object.keys(pack.ascii || {});
      var totalCount = effectIds.length + asciiIds.length;

      if (totalCount === 0) continue;

      var wrapper = document.createElement('div');

      // Toggle header
      var toggle = document.createElement('div');
      toggle.className = 'pack-toggle';
      toggle.innerHTML = '<div class="pack-info"><div class="pack-name">'
        + (pack.icon||'üì¶') + ' ' + pack.name
        + '</div><div class="pack-count">' + totalCount + ' effects</div></div>'
        + '<div class="pack-switch" id="switch-'+packId+'"></div>';

      // Effects container
      var effectsDiv = document.createElement('div');
      effectsDiv.className = 'pack-effects';
      effectsDiv.id = 'effects-' + packId;

      // Group effects by category
      var byCategory = {};
      effectIds.forEach(function(fxId) {
        var fx = pack.effects[fxId];
        var cat = fx.category || 'other';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push({ id: fxId, def: fx });
      });

      // Sort categories
      var sortedCats = Object.keys(byCategory).sort(function(a, b) {
        var ai = catOrder.indexOf(a), bi = catOrder.indexOf(b);
        return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
      });

      // Build effect buttons grouped by category
      sortedCats.forEach(function(cat) {
        var fxList = byCategory[cat];

        var catLabel = document.createElement('div');
        catLabel.className = 'cat-label';
        catLabel.textContent = catLabels[cat] || ('‚ú¶ ' + cat);
        effectsDiv.appendChild(catLabel);

        var grid = document.createElement('div');
        grid.className = 'effects-grid';

        fxList.forEach(function(fx) {
          var zones = fx.def.zones || ['mid'];

          if (fx.def.type === 'text') {
            // Text effect ‚Äî single button
            var btn = document.createElement('div');
            btn.className = 'effect-btn';
            btn.textContent = (fx.def.icon || '‚úèÔ∏è') + ' ' + (fx.def.name || fx.id);
            btn.addEventListener('click', function() {
              toggleEffect(fx.id, 'text', btn);
            });
            grid.appendChild(btn);
          } else if (fx.def.type === 'border' || cat === 'border') {
            // Border effect ‚Äî single button
            var btn = document.createElement('div');
            btn.className = 'effect-btn';
            btn.textContent = (fx.def.icon || 'üî≤') + ' ' + (fx.def.name || fx.id);
            btn.addEventListener('click', function() {
              toggleEffect(fx.id, 'border', btn);
            });
            grid.appendChild(btn);
          } else {
            // Standard effect ‚Äî one button per zone
            zones.forEach(function(zone) {
              var btn = document.createElement('div');
              btn.className = 'effect-btn';
              btn.dataset.fxId = fx.id;
              btn.dataset.zone = zone;
              var zoneBadge = zones.length > 1 ? '.' + zone : '';
              btn.textContent = (fx.def.icon || '‚ú¶') + ' ' + (fx.def.name || fx.id) + zoneBadge;
              btn.addEventListener('click', function() {
                toggleEffect(fx.id, zone, btn);
              });
              grid.appendChild(btn);
            });
          }
        });

        effectsDiv.appendChild(grid);
      });

      // ---- PRESETS ----
      if (pack.presets && Object.keys(pack.presets).length > 0) {
        var presetLabel = document.createElement('div');
        presetLabel.className = 'cat-label';
        presetLabel.textContent = '‚ö° Presets';
        effectsDiv.appendChild(presetLabel);

        var presetGrid = document.createElement('div');
        presetGrid.className = 'effects-grid';

        (function(pack) {
          Object.entries(pack.presets).forEach(function(entry) {
            var presetName = entry[0], fxList = entry[1];
            var btn = document.createElement('div');
            btn.className = 'effect-btn preset-btn';
            btn.textContent = '‚ö° ' + presetName;
            btn.addEventListener('click', function() {
              // Clear everything first
              selections.clear();
              if (Bifrost) Bifrost.deactivateAll();
              document.querySelectorAll('.effect-btn.active').forEach(function(b) { b.classList.remove('active'); });

              // Apply each effect in the preset
              fxList.forEach(function(fxStr) {
                var dotIdx = fxStr.lastIndexOf('.');
                var fxId = fxStr.slice(0, dotIdx);
                var zone = fxStr.slice(dotIdx + 1);
                if (zone === 'text') {
                  if (Bifrost) Bifrost.toggleText('text-' + fxId);
                  selections.set(fxId + '-text', 'text');
                } else if (zone === 'border') {
                  if (Bifrost) Bifrost.activateBorder(fxId, 'border');
                  selections.set(fxId + '-border', 'border');
                } else {
                  if (Bifrost) Bifrost.activate(fxId, zone);
                  selections.set(fxId + '-' + zone, zone);
                }
              });

              // Sync button states
              document.querySelectorAll('.effect-btn[data-fx-id]').forEach(function(b) {
                var key = b.dataset.fxId + '-' + (b.dataset.zone || 'mid');
                b.classList.toggle('active', selections.has(key));
              });

              btn.classList.add('active');
              updateShorthand();
            });
            presetGrid.appendChild(btn);
          });
        })(pack);

        effectsDiv.appendChild(presetGrid);
      }

      // Toggle click handler
      (function(packId) {
        toggle.addEventListener('click', function() {
          var sw = document.getElementById('switch-'+packId);
          var ef = document.getElementById('effects-'+packId);
          var isOn = sw.classList.toggle('on');
          toggle.classList.toggle('enabled', isOn);
          ef.classList.toggle('visible', isOn);
        });
      })(packId);

      wrapper.appendChild(toggle);
      wrapper.appendChild(effectsDiv);
      packList.appendChild(wrapper);
    }

    // ---- Global ASCII Art Section ----
    buildAsciiSection(packList);
  }

  function buildAsciiSection(packList) {
    if (!Bifrost || !Bifrost.getAllAsciiAnims) return;
    var allAscii = Bifrost.getAllAsciiAnims();
    if (Object.keys(allAscii).length === 0) return;

    // Group by pack
    var byPack = {};
    for (var name in allAscii) {
      var a = allAscii[name];
      var pName = a.packName || 'Unknown';
      if (!byPack[pName]) byPack[pName] = [];
      byPack[pName].push({ id: name, label: a.label || name, icon: a.icon || '‚ñ∏' });
    }

    var section = document.createElement('div');
    section.className = 'ascii-section';
    section.innerHTML = '<h3 style="color:#00ff88;margin-bottom:0.75rem;">üéÆ ASCII Art</h3>';

    var asciiList = document.createElement('div');
    asciiList.id = 'asciiEntries';
    section.appendChild(asciiList);

    // Add button
    var addBtn = document.createElement('div');
    addBtn.className = 'effect-btn';
    addBtn.style.cssText = 'display:inline-block;margin-top:0.5rem;border-color:#00ff88;color:#00ff88;';
    addBtn.textContent = '+ Add ASCII Art';
    addBtn.addEventListener('click', function() {
      addAsciiEntry(asciiList, byPack, allAscii);
    });
    section.appendChild(addBtn);

    packList.appendChild(section);
  }

  function addAsciiEntry(container, byPack, allAscii) {
    var entry = document.createElement('div');
    entry.className = 'ascii-controls';
    entry.style.marginBottom = '0.5rem';

    // Pack dropdown
    var packSel = document.createElement('select');
    packSel.className = 'ascii-select';
    packSel.innerHTML = '<option value="">‚Äî select pack ‚Äî</option>';
    for (var pName in byPack) {
      var opt = document.createElement('option');
      opt.value = pName;
      opt.textContent = pName;
      packSel.appendChild(opt);
    }
    entry.appendChild(packSel);

    // Animation dropdown (populated on pack select)
    var animSel = document.createElement('select');
    animSel.className = 'ascii-select';
    animSel.style.marginTop = '0.3rem';
    animSel.innerHTML = '<option value="">‚Äî select animation ‚Äî</option>';
    animSel.disabled = true;
    entry.appendChild(animSel);

    packSel.addEventListener('change', function() {
      animSel.innerHTML = '<option value="">‚Äî select animation ‚Äî</option>';
      var anims = byPack[packSel.value] || [];
      anims.forEach(function(a) {
        var opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.icon + ' ' + a.label;
        animSel.appendChild(opt);
      });
      animSel.disabled = anims.length === 0;
    });

    // Controls row: zone, color
    var ctrlRow = document.createElement('div');
    ctrlRow.className = 'ascii-options';
    ctrlRow.style.marginTop = '0.4rem';
    ctrlRow.innerHTML =
      '<label>Zone: <select class="ascii-zone-sel">' +
        '<option value="mid">Mid</option><option value="top">Top</option><option value="bot">Bot</option>' +
      '</select></label>' +
      '<label>Color: <select class="ascii-color-sel">' +
        '<option value="#00ff88">Green</option><option value="#00ffff">Cyan</option>' +
        '<option value="#ff00ff">Magenta</option><option value="#ffaa00">Amber</option>' +
        '<option value="#ff4444">Red</option><option value="#ffffff">White</option>' +
      '</select></label>';
    entry.appendChild(ctrlRow);

    // X/Y sliders
    function makeSlider(label, id, defaultVal) {
      var div = document.createElement('div');
      div.style.marginTop = '0.3rem';
      div.innerHTML = '<label style="color:#888;font-size:0.7rem;">' + label + ': <span class="' + id + '-val">'+defaultVal+'</span>%</label>' +
        '<input type="range" class="' + id + '-range" min="0" max="100" value="'+defaultVal+'" style="width:100%;accent-color:#00ff88;">';
      div.querySelector('input').addEventListener('input', function() {
        div.querySelector('.' + id + '-val').textContent = this.value;
        // Update position live if playing
        if (entry._playing && entry._playingId && Bifrost && Bifrost.updateAsciiPos) {
          var xv = parseInt(entry.querySelector('.ascii-x-range').value);
          var yv = parseInt(entry.querySelector('.ascii-y-range').value);
          Bifrost.updateAsciiPos(entry._playingId, xv, yv);
        }
      });
      return div;
    }
    entry.appendChild(makeSlider('X', 'ascii-x', 50));
    entry.appendChild(makeSlider('Y', 'ascii-y', 50));

    // Button row: Play/Stop + Remove
    var btnRow = document.createElement('div');
    btnRow.style.cssText = 'display:flex;gap:0.5rem;margin-top:0.4rem;';

    var playBtn = document.createElement('div');
    playBtn.className = 'effect-btn';
    playBtn.textContent = '‚ñ∂ Play';
    playBtn.addEventListener('click', function() {
      var animId = animSel.value;
      if (!animId) return;
      var zone = entry.querySelector('.ascii-zone-sel').value;
      var color = entry.querySelector('.ascii-color-sel').value;
      var x = parseInt(entry.querySelector('.ascii-x-range').value);
      var y = parseInt(entry.querySelector('.ascii-y-range').value);

      if (entry._playing) {
        if (Bifrost && Bifrost.stopAscii) Bifrost.stopAscii(entry._playingId);
        selections.delete('ascii:' + entry._playingId);
        playBtn.textContent = '‚ñ∂ Play';
        playBtn.classList.remove('active');
        entry._playing = false;
        entry._playingId = null;
      } else {
        if (Bifrost && Bifrost.playAscii) Bifrost.playAscii(animId, zone, x, y, color);
        selections.set('ascii:' + animId, zone);
        playBtn.textContent = '‚èπ Stop';
        playBtn.classList.add('active');
        entry._playing = true;
        entry._playingId = animId;
      }
      updateShorthand();
    });
    btnRow.appendChild(playBtn);

    var removeBtn = document.createElement('div');
    removeBtn.className = 'effect-btn';
    removeBtn.style.cssText = 'border-color:#ff4444;color:#ff4444;';
    removeBtn.textContent = '‚úï';
    removeBtn.addEventListener('click', function() {
      if (entry._playing) {
        if (Bifrost && Bifrost.stopAscii) Bifrost.stopAscii(entry._playingId);
        selections.delete('ascii:' + entry._playingId);
        updateShorthand();
      }
      entry.remove();
    });
    btnRow.appendChild(removeBtn);

    entry.appendChild(btnRow);
    container.appendChild(entry);
  }

  // ---- Effect toggling ----
  function toggleEffect(fxId, zone, btn) {
    var key = fxId + '-' + zone;
    if (selections.has(key)) {
      if (Bifrost) Bifrost.deactivate(fxId, zone);
      selections.delete(key);
      btn.classList.remove('active');
    } else {
      if (Bifrost) Bifrost.activate(fxId, zone);
      selections.set(key, zone);
      btn.classList.add('active');
    }
    updateShorthand();
  }

  function updateShorthand() {
    var parts = [];
    selections.forEach(function(zone, key) {
      if (key.startsWith('ascii:')) {
        parts.push(key + '.' + zone);
      } else {
        // key is fxId-zone, we want fxId.zone
        var dashIdx = key.lastIndexOf('-');
        var fxId = key.slice(0, dashIdx);
        var z = key.slice(dashIdx + 1);
        parts.push(fxId + '.' + z);
      }
    });
    currentShorthand = parts.join(',');
    document.getElementById('shorthandDisplay').value = currentShorthand || 'No effects selected';
  }

  // ---- Toast ----
  function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2500);
  }

  // ---- Actions ----
  document.getElementById('btnApply').addEventListener('click', function() {
    var raw = document.getElementById('shorthandDisplay').value.trim();
    if (!raw || raw === 'No effects selected') return;
    selections.clear();
    document.querySelectorAll('.effect-btn.active').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.ascii-play-btn').forEach(function(b) { b.textContent = '‚ñ∂ Play'; b.classList.remove('active'); });
    if (Bifrost) {
      Bifrost.applyShorthand(raw);
      // Rebuild selections from active state
      Object.entries(Bifrost.active).forEach(function(entry) {
        var key = entry[0];
        var info = entry[1];
        selections.set(key, info.zone);
        // Sync button states
        document.querySelectorAll('.effect-btn[data-fx-id]').forEach(function(b) {
          if (b.dataset.fxId === info.effectId && b.dataset.zone === info.zone) b.classList.add('active');
        });
      });
      // Sync text effects
      if (Bifrost.activeText) {
        Bifrost.activeText.forEach(function(cls) {
          selections.set(cls + '-text', 'text');
        });
      }
    }
    currentShorthand = raw;
    showToast('Shorthand applied!');
  });

  document.getElementById('btnSave').addEventListener('click', function() {
    var sent = sendToPhoneTool({ type: 'bifrost-save-local', alias: alias, shorthand: currentShorthand });
    if (sent) {
      showToast('Saved! Badge updated on phonetool page.');
    } else {
      // Opener lost (page was reloaded) ‚Äî copy console command instead
      var cmd = "localStorage.setItem('bifrost_frame_" + alias + "', '" + currentShorthand + "')";
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(cmd).then(function() {
          showToast('Phonetool connection lost. Save command copied ‚Äî paste in phonetool console.');
        });
      } else {
        showToast('Phonetool connection lost. Re-open lab from phonetool to save.');
      }
    }
  });

  document.getElementById('btnCopy').addEventListener('click', function() {
    var str = 'fx:' + currentShorthand;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(str).then(function() {
        showToast('Copied shorthand to clipboard.');
      }).catch(function() { fallbackCopy(str); });
    } else { fallbackCopy(str); }
  });

  function fallbackCopy(str) {
    var ta = document.createElement('textarea');
    ta.value = str;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    showToast('Copied shorthand to clipboard.');
  }

  document.getElementById('btnClear').addEventListener('click', function() {
    currentShorthand = '';
    selections.clear();
    if (Bifrost) Bifrost.deactivateAll();
    document.querySelectorAll('.effect-btn.active').forEach(function(b) { b.classList.remove('active'); });
    document.querySelectorAll('.ascii-play-btn').forEach(function(b) { b.textContent = '‚ñ∂ Play'; b.classList.remove('active'); });
    document.getElementById('shorthandDisplay').value = 'No effects selected';
    sendToPhoneTool({ type: 'bifrost-clear-local', alias: alias });
    showToast('Effects cleared.' + (!window.opener || window.opener.closed ? ' Re-open lab from phonetool to sync.' : ''));
  });
}
</script>
</body>
</html>
